name: Test Import Fixes

on:
  push:
    branches:
      - main
      - master
      - 'fix/**'
  pull_request:
    branches:
      - main
      - master

jobs:
  test-imports:
    name: Test Python Imports
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false  # Don't need full storymem_src for import tests

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install core dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          pip install numpy pillow easydict typing_extensions

      - name: Install package in development mode
        run: |
          pip install -e .

      - name: Run import tests
        run: |
          python -m pytest tests/test_imports.py -v --tb=short

      - name: Test direct imports
        run: |
          python -c "from storymem_wrapper.keyframe_extractor import KeyframeExtractor; print('✓ keyframe_extractor imports OK')"
          python -c "from storymem_wrapper import storymem_bridge; print('✓ storymem_bridge imports OK')"
          python -c "from typing import Dict, Any; print('✓ typing imports OK')"

      - name: Check for NameError in module loading
        run: |
          python -c "
          import sys
          try:
              from storymem_wrapper.keyframe_extractor import KeyframeExtractor
              print('✓ No NameError in keyframe_extractor')
          except NameError as e:
              print(f'✗ NameError detected: {e}')
              sys.exit(1)
          "

  test-syntax:
    name: Check Python Syntax
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Check syntax of all Python files
        run: |
          python -m py_compile storymem_wrapper/*.py
          python -m py_compile tests/*.py
          echo "✓ All Python files have valid syntax"

      - name: Install flake8
        run: |
          pip install flake8

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 storymem_wrapper/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 storymem_wrapper/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  test-with-storymem:
    name: Test with StoryMem Source
    runs-on: ubuntu-latest
    # This job tests when the full storymem_src is available

    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

          # Install minimal requirements for import tests
          pip install numpy pillow easydict typing_extensions transformers diffusers peft

      - name: Test imports with storymem_src available
        run: |
          python -c "
          import sys
          from pathlib import Path

          # Add storymem_src to path (mimics what storymem_bridge does)
          storymem_path = Path('storymem_src')
          if storymem_path.exists():
              sys.path.insert(0, str(storymem_path))
              print('✓ storymem_src directory found')

          # Try importing the bridge
          try:
              from storymem_wrapper import storymem_bridge
              print(f'✓ storymem_bridge imported')
              print(f'  STORYMEM_AVAILABLE: {storymem_bridge.STORYMEM_AVAILABLE}')

              # If available, verify the correct class name is used
              if storymem_bridge.STORYMEM_AVAILABLE:
                  print('✓ StoryMem modules loaded successfully')
              else:
                  print('⚠ StoryMem not available (missing dependencies)')

          except ImportError as e:
              if 'WanMI2V' in str(e):
                  print(f'✗ FAIL: Incorrect class name WanMI2V used')
                  sys.exit(1)
              else:
                  print(f'⚠ Import warning (expected): {e}')
          except NameError as e:
              print(f'✗ FAIL: NameError (missing type imports): {e}')
              sys.exit(1)
          "

      - name: Run full test suite
        run: |
          pip install pytest
          python -m pytest tests/ -v

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-imports, test-syntax, test-with-storymem]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Test Import Fixes - Results:"
          echo "  - Import tests: ${{ needs.test-imports.result }}"
          echo "  - Syntax check: ${{ needs.test-syntax.result }}"
          echo "  - With StoryMem: ${{ needs.test-with-storymem.result }}"

          if [[ "${{ needs.test-imports.result }}" == "failure" ]] || \
             [[ "${{ needs.test-syntax.result }}" == "failure" ]]; then
            echo "❌ Tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi
